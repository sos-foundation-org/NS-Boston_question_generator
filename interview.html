<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interview Question Picker</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; margin: 24px; line-height: 1.4; }
    .card { max-width: 980px; margin: 0 auto; padding: 18px; border: 1px solid #ddd; border-radius: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; }
    label { display: block; font-size: 14px; margin-bottom: 6px; color: #333; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; font-size: 16px; }
    button { padding: 12px 16px; border: 0; border-radius: 12px; font-size: 16px; cursor: pointer; }
    button.primary { background: #111; color: #fff; }
    button.secondary { background: #f2f2f2; }
    .muted { color: #666; }
    .error { color: #b00020; margin-top: 10px; }
    .ok { color: #0b6b2e; margin-top: 10px; }
    .actions { display: flex; gap: 10px; align-items: center; margin-top: 12px; flex-wrap: wrap; }
    .qList { margin-top: 16px; }
    .qItem { padding: 10px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 8px; display:flex; gap:10px; align-items:flex-start;}
    .qMeta { min-width: 160px; }
    .tag { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f1f1f1; margin-right:6px; margin-bottom:6px; }
    .two { display: grid; grid-template-columns: 1fr 320px; gap: 16px; align-items: start; margin-top: 16px; }
    .qrBox { border: 1px solid #ddd; border-radius: 12px; padding: 12px; text-align: center; }
    .big { font-size: 34px; font-weight: 800; letter-spacing: 1px; margin: 0 0 8px; word-break: break-all; }
    @media (max-width: 860px) { .row { grid-template-columns: 1fr; } .two { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <div style="margin-bottom:16px;">
      <a href="index.html" style="
        display:inline-block;
        padding:8px 14px;
        border-radius:10px;
        background:#f2f2f2;
        text-decoration:none;
        color:#111;
        font-size:14px;
      ">
        ← Back to Home
      </a>
    </div>

    <h1 style="margin-top:0;">Interview Question Picker</h1>
    <p class="muted" style="margin-top:-6px;">選角色 → 載入題目 → 勾選題目 → 生成 index + QR</p>

    <!-- Picker UI wrapper (hidden after Save/Generate) -->
    <div id="picker">
      <div class="row">
        <div>
          <label>Username（必填）</label>
          <input id="username" placeholder="例如: weiping / alice / bob" />
        </div>
        <div>
          <label>Date（必填）</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>Category（必填）</label>
          <select id="role">
            <option value="一般人">一般人</option>
            <option value="政策">政策</option>
            <option value="科學家">科學家</option>
            <option value="商業">商業</option>
            <option value="藝術家">藝術家</option>
          </select>
        </div>
        <div>
          <label>Location（必填）</label>
          <select id="location">
            <option value="BOS">BOS</option>
            <option value="NYC">NYC</option>
            <option value="TWN">TWN</option>
          </select>
        </div>
        <div>
          <label>Language（必填）</label>
          <select id="lang">
            <option value="zh">中文</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <div style="flex:1; min-width: 240px;">
          <label style="margin-top:0;">Passcode（可選）</label>
          <input id="passcode" placeholder="若啟用存取控制才需要" />
        </div>
        <button class="secondary" id="loadBtn">Load Questions</button>
        <button class="primary" id="saveBtn" style="display:none;">Save / Generate</button>
      </div>

      <div id="msg"></div>
      <div class="qList" id="qList"></div>
    </div>

    <!-- Result UI -->
    <div id="result" style="display:none;">
      <div class="two">
        <div>
          <div class="big" id="interviewIndex"></div>
          <div class="muted">（把 index + 右側 QR 對準鏡頭）</div>
          <div class="actions" style="margin-top:10px;">
            <button class="secondary" id="resetBtn">Pick Again</button>
          </div>
        </div>
        <div class="qrBox">
          <canvas id="qrCanvas" width="260" height="260"></canvas>
          <div class="muted" style="margin-top:6px; font-size: 12px;">QR 內容：interview_index</div>
        </div>
      </div>

      <div class="qList" id="selectedList"></div>
      <div id="msg2"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwmyiF0Gk8LnSedX6K1OB05X2Uh4v2LU2CpI4SHfNcVUY-1VJTL6u4i9-QADAp-1ROq/exec";

    const $ = (id) => document.getElementById(id);

    const picker = $("picker");
    const result = $("result");
    const qList = $("qList");

    const loadBtn = $("loadBtn");
    const saveBtn = $("saveBtn");
    const resetBtn = $("resetBtn");

    const msg = $("msg");
    const msg2 = $("msg2");

    const qr = new QRious({ element: $("qrCanvas"), size: 260, value: "" });

    // default date
    const today = new Date();
    $("date").value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

    function setMsg(kind, text) {
      msg.className = kind === "error" ? "error" : "ok";
      msg.textContent = text;
    }
    function setMsg2(kind, text) {
      msg2.className = kind === "error" ? "error" : "ok";
      msg2.textContent = text;
    }
    function clearMsg(){ msg.className=""; msg.textContent=""; }
    function clearMsg2(){ msg2.className=""; msg2.textContent=""; }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function jsonp(url, params) {
      return new Promise((resolve, reject) => {
        const cbName = "__cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");

        params = params || {};
        params.callback = cbName;

        script.src = url + "?" + new URLSearchParams(params).toString();

        window[cbName] = (data) => {
          delete window[cbName];
          script.remove();
          resolve(data);
        };

        script.onerror = () => {
          delete window[cbName];
          script.remove();
          reject(new Error("JSONP request failed"));
        };

        document.body.appendChild(script);
      });
    }

    let loadedQuestions = []; // {question_id, priority, section, role, text}

    function renderSelectableQuestions(list) {
      qList.innerHTML = "";
      list.forEach(q => {
        const div = document.createElement("div");
        div.className = "qItem";
        div.innerHTML = `
          <div class="qMeta">
            <label style="display:flex; gap:8px; align-items:center; margin:0;">
              <input type="checkbox" class="qChk" data-id="${escapeHtml(q.question_id)}" />
              <span style="font-weight:700;">${escapeHtml(q.question_id)}</span>
            </label>
            <div style="margin-top:6px;">
              <span class="tag">Priority ${escapeHtml(q.priority)}</span>
              <span class="tag">${escapeHtml(q.section || "")}</span>
              <span class="tag">${escapeHtml(q.role || "")}</span>
            </div>
          </div>
          <div style="flex:1;">
            <div style="font-size:16px; font-weight:700;">${escapeHtml(q.text || "")}</div>
          </div>
        `;
        qList.appendChild(div);
      });
    }

    function getSelectedIds() {
      return Array.from(document.querySelectorAll(".qChk:checked"))
        .map(x => x.getAttribute("data-id"));
    }

    function renderSelectedQuestions(selected) {
      // Sort by Question ID (e.g., G1, G2, C3, P10, SYS2 ...)
      selected.sort((a, b) => {
        const parse = (id) => {
          const m = String(id).trim().match(/^([^\d]+)(\d+)$/);
          if (!m) return { prefix: String(id).trim(), num: 0 };
          return { prefix: m[1], num: parseInt(m[2], 10) };
        };
        const A = parse(a.question_id);
        const B = parse(b.question_id);
        if (A.prefix < B.prefix) return -1;
        if (A.prefix > B.prefix) return 1;
        return A.num - B.num;
      });

      const box = $("selectedList");
      box.innerHTML = "";
      selected.forEach((q, idx) => {
        const div = document.createElement("div");
        div.className = "qItem";
        div.innerHTML = `
          <div class="qMeta">
            <div style="font-weight:800;">${idx+1}. ${escapeHtml(q.question_id)}</div>
            <div style="margin-top:6px;">
              <span class="tag">Priority ${escapeHtml(q.priority)}</span>
              <span class="tag">${escapeHtml(q.section || "")}</span>
              <span class="tag">${escapeHtml(q.role || "")}</span>
            </div>
          </div>
          <div style="flex:1;">
            <div style="font-size:16px; font-weight:700;">${escapeHtml(q.text || "")}</div>
          </div>
        `;
        box.appendChild(div);
      });
    }

    async function loadQuestions() {
      clearMsg();
      clearMsg2();
      result.style.display = "none";

      const role = $("role").value.trim();
      const lang = $("lang").value.trim();

      try {
        const data = await jsonp(API_URL, {
          action: "listInterviewQuestions",
          role,
          lang,
          _: Date.now()
        });

        if (!data.ok) {
          setMsg("error", `失敗（${data.code || "?"}）：${data.error || "Unknown error"}`);
          return;
        }

        loadedQuestions = data.questions || [];
        renderSelectableQuestions(loadedQuestions);
        setMsg("ok", `已載入 ${loadedQuestions.length} 題（role=全部+${role}，lang=${lang}）。`);

        // Button state switch
        loadBtn.style.display = "none";
        saveBtn.style.display = "inline-block";

      } catch (e) {
        setMsg("error", `網路或 API 錯誤：${e}`);
      }
    }

    async function saveInterview() {
      clearMsg();
      clearMsg2();
      result.style.display = "none";

      const username = $("username").value.trim();
      const date = $("date").value.trim();
      const role = $("role").value.trim();
      const location = $("location").value.trim();
      const lang = $("lang").value.trim();
      const passcode = $("passcode").value.trim();

      if (!username || !date || !role || !location) {
        setMsg("error", "請先填完 username / date / category / location。");
        return;
      }

      const selectedIds = getSelectedIds();
      if (selectedIds.length === 0) {
        setMsg("error", "請至少勾選 1 題。");
        return;
      }

      try {
        const data = await jsonp(API_URL, {
          action: "saveInterview",
          username,
          date,
          role,
          location,
          lang,
          passcode,
          selected_ids: selectedIds.join(","),
          _: Date.now()
        });

        if (!data.ok) {
          setMsg("error", `失敗（${data.code || "?"}）：${data.error || "Unknown error"}`);
          return;
        }

        const idx = data.interview_index;
        $("interviewIndex").textContent = idx;
        qr.value = idx;

        // ✅ render selected questions
        renderSelectedQuestions(data.selected || []);

        result.style.display = "block";

        // Hide picker after generating (your request)
        picker.style.display = "none";

        setMsg2("ok", "成功：已寫入 interview-log，並生成 index + QR。");

      } catch (e) {
        setMsg("error", `網路或 API 錯誤：${e}`);
      }
    }

    function resetPicker() {
      // show picker again
      picker.style.display = "block";
      result.style.display = "none";
      clearMsg();
      clearMsg2();

      // clear checks
      document.querySelectorAll(".qChk").forEach(x => x.checked = false);

      // reset buttons: Load visible, Save hidden
      loadBtn.style.display = "inline-block";
      saveBtn.style.display = "none";

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    loadBtn.addEventListener("click", loadQuestions);
    saveBtn.addEventListener("click", saveInterview);
    resetBtn.addEventListener("click", resetPicker);

    // optional: auto-reload when role/lang changes -> resets to "Load" stage
    function onConfigChanged() {
      // clear list + buttons back to initial
      qList.innerHTML = "";
      document.querySelectorAll(".qChk").forEach(x => x.checked = false);
      loadBtn.style.display = "inline-block";
      saveBtn.style.display = "none";
      clearMsg();
      clearMsg2();
    }
    $("role").addEventListener("change", onConfigChanged);
    $("lang").addEventListener("change", onConfigChanged);
  </script>
</body>
</html>
