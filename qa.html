<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quick Q&A</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; margin: 24px; line-height: 1.4; }
    .card { max-width: 980px; margin: 0 auto; padding: 18px; border: 1px solid #ddd; border-radius: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { display: block; font-size: 14px; margin-bottom: 6px; color: #333; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; font-size: 16px; }
    button { padding: 12px 16px; border: 0; border-radius: 12px; font-size: 16px; cursor: pointer; }
    button.primary { background: #111; color: #fff; }
    button.secondary { background: #f2f2f2; }
    .big { font-size: 44px; font-weight: 800; letter-spacing: 1px; margin: 18px 0 8px; word-break: break-all; }
    .muted { color: #666; }
    .two { display: grid; grid-template-columns: 1fr 320px; gap: 16px; align-items: start; }
    .qrBox { border: 1px solid #ddd; border-radius: 12px; padding: 12px; text-align: center; }
    .qList { margin-top: 16px; }
    .qItem { padding: 12px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 10px; }
    .tag { display: inline-block; font-size: 12px; padding: 4px 8px; border-radius: 999px; background: #f1f1f1; margin-bottom: 8px; }
    .actions { display: flex; gap: 10px; align-items: center; margin-top: 12px; flex-wrap: wrap; }
    .error { color: #b00020; margin-top: 10px; }
    .ok { color: #0b6b2e; margin-top: 10px; }
    @media (max-width: 860px) {
      .row { grid-template-columns: 1fr; }
      .two { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="card">
    <div style="margin-bottom:16px;">
      <a href="index.html" style="
        display:inline-block;
        padding:8px 14px;
        border-radius:10px;
        background:#f2f2f2;
        text-decoration:none;
        color:#111;
        font-size:14px;
      ">
        ← Back to Home
      </a>
    </div>

    <h1 style="margin-top:0;">Quick Q&amp;A</h1>
    <p class="muted" style="margin-top:-6px;">輸入基本資訊 → 生成 index + QR → 抽題 → 自動寫入 log</p>

    <div class="row">
      <div>
        <label>Username（必填）</label>
        <input id="username" placeholder="例如: weiping / alice / bob" />
      </div>
      <div>
        <label>Date（必填）</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>Location（必填）</label>
        <select id="location">
          <option value="BOS">BOS</option>
          <option value="NYC">NYC</option>
          <option value="TWN">TWN</option>
        </select>
      </div>

      <div>
        <label>Language（必填）</label>
        <select id="lang">
          <option value="zh">中文</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <div style="flex:1; min-width: 240px;">
        <label style="margin-top:0;">Passcode（可選）</label>
        <input id="passcode" placeholder="若啟用存取控制才需要" />
      </div>
      <button class="primary" id="btn">Start / Generate</button>
      <button class="secondary" id="copyBtn" disabled>Copy Index</button>
    </div>

    <div id="msg"></div>

    <div id="result" style="display:none; margin-top: 16px;">
      <div class="two">
        <div>
          <div class="big" id="trialIndex"></div>
          <div class="muted">（請把上面的 index + 右側 QR 對準鏡頭）</div>
        </div>
        <div class="qrBox">
          <canvas id="qrCanvas" width="260" height="260"></canvas>
          <div class="muted" style="margin-top:6px; font-size: 12px;">QR 內容：trial_index</div>
        </div>
      </div>

      <div class="qList" id="qList"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <script>
    const API_URL = "https://script.google.com/a/*/macros/s/AKfycbwmyiF0Gk8LnSedX6K1OB05X2Uh4v2LU2CpI4SHfNcVUY-1VJTL6u4i9-QADAp-1ROq/exec";

    const $ = (id) => document.getElementById(id);
    const msg = $("msg");
    const result = $("result");
    const btn = $("btn");
    const copyBtn = $("copyBtn");

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    $("date").value = `${yyyy}-${mm}-${dd}`;

    const qr = new QRious({
      element: $("qrCanvas"),
      size: 260,
      value: ""
    });

    function setMsg(kind, text) {
      msg.className = kind === "error" ? "error" : "ok";
      msg.textContent = text;
    }

    function clearMsg() {
      msg.className = "";
      msg.textContent = "";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function jsonp(url, params) {
      return new Promise((resolve, reject) => {
        const cbName = "__cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");

        params = params || {};
        params.callback = cbName;

        const qs = new URLSearchParams(params).toString();
        script.src = url + "?" + qs;

        window[cbName] = (data) => {
          delete window[cbName];
          script.remove();
          resolve(data);
        };

        script.onerror = () => {
          delete window[cbName];
          script.remove();
          reject(new Error("JSONP request failed"));
        };

        document.body.appendChild(script);
      });
    }

    function renderQuestions(selected, lang) {
      const box = $("qList");
      box.innerHTML = "";

      const isZh = (lang === "zh");

      selected.forEach((q, idx) => {
        const div = document.createElement("div");
        div.className = "qItem";

        if (isZh) {
          div.innerHTML = `
            <div class="tag">${escapeHtml(q.type)} · ${escapeHtml(q.question_id)}</div>
            <div style="font-size:18px; font-weight:700; margin-bottom:6px;">${idx+1}. ${escapeHtml(q["題目"] || "")}</div>
            <div class="muted">回答提示：${escapeHtml(q["回答"] || "")}</div>
          `;
        } else {
          div.innerHTML = `
            <div class="tag">${escapeHtml(q.type)} · ${escapeHtml(q.question_id)}</div>
            <div style="font-size:18px; font-weight:700; margin-bottom:6px;">${idx+1}. ${escapeHtml(q["Question"] || "")}</div>
            <div class="muted">Answer prompt: ${escapeHtml(q["Answer"] || "")}</div>
          `;
        }

        box.appendChild(div);
      });
    }

    async function startTrial() {
      clearMsg();
      result.style.display = "none";
      copyBtn.disabled = true;

      const username = $("username").value.trim();
      const date = $("date").value.trim();
      const location = $("location").value.trim();
      const lang = $("lang").value.trim();
      const passcode = $("passcode").value.trim();

      if (!username || !date || !location || !lang) {
        setMsg("error", "請先填完 username / date / location / language。");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Generating...";

      try {
        const data = await jsonp(API_URL, {
          action: "startTrial",
          username,
          date,
          location,
          lang,
          passcode,
          _: Date.now()
        });

        if (!data.ok) {
          setMsg("error", `失敗（${data.code || "?"}）：${data.error || "Unknown error"}`);
          return;
        }

        const trialIndex = data.trial_index;
        $("trialIndex").textContent = trialIndex;
        qr.value = trialIndex;

        renderQuestions(data.selected || [], lang);
        result.style.display = "block";
        setMsg("ok", "成功：已生成 index、抽題並寫入 log。");

        copyBtn.disabled = false;
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText(trialIndex);
          setMsg("ok", "已複製 index。");
        };

      } catch (e) {
        setMsg("error", `網路或 API 錯誤：${e}`);
      } finally {
        btn.disabled = false;
        btn.textContent = "Start / Generate";
      }
    }

    btn.addEventListener("click", startTrial);
  </script>
</body>
</html>
